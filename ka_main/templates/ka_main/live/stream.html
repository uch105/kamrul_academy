{% extends 'ka_main/live/base.html' %}
{% load static %}

{% block title %}
{% endblock %}

{% block body %}


    <h1>Teacher Stream</h1>
    <video id="videoElement" autoplay playsinline></video>
    <button id="startCapture">Start Capture</button>
    <button id="shareScreen">Share Screen</button>
    <button id="stopCapture">Stop Capture</button>
    <script>
        const videoElement = document.getElementById('videoElement');
        const startCaptureButton = document.getElementById('startCapture');
        const shareScreenButton = document.getElementById('shareScreen');
        const stopCaptureButton = document.getElementById('stopCapture');

        let mediaRecorder;
        let stream;

        let protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        let socket = new WebSocket(protocol + '//' + window.location.host + '/ws/stream/');

        socket.onopen = () => console.log('WebSocket connection opened');
        socket.onclose = () => console.log('WebSocket connection closed');

        startCaptureButton.addEventListener('click', async () => {
            stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            videoElement.srcObject = stream;
            startSendingFrames(stream);
        });

        shareScreenButton.addEventListener('click', async () => {
            stopSendingFrames();
            stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            videoElement.srcObject = stream;
            startSendingFrames(stream);
        });

        stopCaptureButton.addEventListener('click', () => {
            stopSendingFrames();
            stream.getTracks().forEach(track => track.stop());
        });

        function startSendingFrames(stream) {
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp9' });

            mediaRecorder.ondataavailable = function (event) {
                if (event.data.size > 0) {
                    socket.send(event.data);
                }
            };

            mediaRecorder.start(100); // Send data every 100ms
        }

        function stopSendingFrames() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        }
    </script>


{% endblock %}