{% extends 'ka_main/live/base.html' %}
{% load static %}

{% block title %}
{% endblock %}

{% block body %}


    <h1>Teacher Stream</h1>
    <video id="teacherVideo" autoplay muted></video>
    <button id="startStream">Start Stream</button>
    <button id="shareScreen">Share Screen</button>
    <button id="stopStream">Stop Streaming</button>
    <script>
        const videoElement = document.getElementById('teacherVideo');
        const startStreamButton = document.getElementById('startStream');
        const shareScreenButton = document.getElementById('shareScreen');
        const stopStreamButton = document.getElementById('stopStream');
        let mediaRecorder;
        let ws;

        startStreamButton.addEventListener('click', async () => {
            if (ws) {
                ws.close();
            }

            ws = new WebSocket('wss://' + window.location.host + '/ws/live/');
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            videoElement.srcObject = stream;
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = function(e) {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ message: e.data }));
                }
            };

            mediaRecorder.start(1000); // Send data in chunks every second
        });

        shareScreenButton.addEventListener('click', async () => {
            if (mediaRecorder) {
                mediaRecorder.stop();
            }
            
            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            videoElement.srcObject = stream;
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = function(e) {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ message: e.data }));
                }
            };

            mediaRecorder.start(1000); // Send data in chunks every second

            // Stop screen share and switch back to webcam if stream ends
            stream.getVideoTracks()[0].addEventListener('ended', () => {
                startStreamButton.click();
            });
        });

        stopStreamButton.addEventListener('click', () => {
            if (mediaRecorder) {
                mediaRecorder.stop();
            }
            if (ws) {
                ws.close();
            }
        });
    </script>


{% endblock %}